<%- include("../../partials/header") %>
<main class="content">
  <div class="container-fluid p-0">

    <h1 class="h3 mb-3">Results</h1>

    <div class="row">
      <div class="col-md-6 col-lg-4  col-xxl-4">
        <div class="card">
          <div class="card-header">
            <div class="input-group">
              <select name="term" id="term" class="form-select">
                <option disabled selected hidden>Select a Term</option>
                <% academicYears.forEach((year) => { %>
                <optgroup label="<%= year.year %>">
                  <% year.Terms.forEach((term) => { %>
                  <option value="<%= term.id %>" <%= selectedTerm === term.id ? "selected" : "" %>><%= term.name %></option>
                  <% }) %>
                </optgroup>
                <% }) %>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-12">
        <div class="card">
          <div class="card-body">
            <% if(student && Object.keys(student).length > 0) { %>
            <div class="mb-2">
              <h6 class="text-uppercase text-muted mb-2">Student Info</h6>
              <div class="d-flex flex-wrap align-items-center" style="gap: .75em 1em;">
                <div class="d-inline-flex align-items-center bg-light border rounded px-3 py-2">
                  <span class="text-uppercase text-muted small">Name</span>
                  <span class="badge bg-primary ms-2"><%= student.firstName %> <%= student.middleName %> <%= student.lastName %></span>
                </div>
                <div class="d-inline-flex align-items-center bg-light border rounded px-3 py-2">
                  <span class="text-uppercase text-muted small">Reg No</span>
                  <span class="badge bg-secondary ms-2"><%= student.registrationNumber %></span>
                </div>
                <div class="d-inline-flex align-items-center bg-light border rounded px-3 py-2">
                  <span class="text-uppercase text-muted small">Class</span>
                  <span class="badge bg-info text-dark ms-2"><%= (student.Class ? student.Class.name : "") %></span>
                </div>
                <div class="d-inline-flex align-items-center bg-light border rounded px-3 py-2">
                  <span class="text-uppercase text-muted small">Term</span>
                  <span class="badge bg-warning text-dark ms-2"><%= term && term.name ? term.name : "" %></span>
                </div>
                <div class="d-inline-flex align-items-center bg-light border rounded px-3 py-2">
                  <span class="text-uppercase text-muted small">Year</span>
                  <span class="badge bg-success ms-2"><%= academicYear && academicYear.year ? academicYear.year : "" %></span>
                </div>
              </div>
            </div>
            <% } %>
          </div>
        </div>
  </div>
  </div>

    <div class="row">
      <div class="col-md-12">
        <ul class="nav nav-tabs" role="tablist">
          <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#account" role="tab">Results</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#password" role="tab">More info</a>
          </li>
        </ul>
      </div>
    </div>

    <div class="row">
      <div class="col-md-12">
        <div class="tab-content">
          <div class="tab-pane fade show active" id="account" role="tabpanel">

            <div class="card">
              <div class="card-body h-100">
                <% if(selectedTerm) { %>
                <div class="d-flex flex-wrap mb-3" style="gap: 1em 2em;">
                  <p><b>TOTAL:</b> <span class="border border-2 p-1 px-3"><%= (getStudentTermPerformance && getStudentTermPerformance.totalScore != null) ? getStudentTermPerformance.totalScore : 0 %></span></p>
                  <p><b>AVERAGE:</b> <span class="border border-2 p-1 px-3"><%= (getStudentTermPerformance && getStudentTermPerformance.averageScore != null) ? getStudentTermPerformance.averageScore : 0 %></span></p>
                  <p><b>POSITION:</b> <span class="border border-2 p-1 px-3"><%= (getStudentTermPerformance && getStudentTermPerformance.position != null) ? getStudentTermPerformance.position : '' %></span></p>
                  <p><b>OUT OF:</b> <span class="border border-2 p-1 px-3"><%= outOf %></span></p>
                  <p><b>REMARK:</b> <span class="border border-2 p-1 px-3"><%= (getStudentTermPerformance && getStudentTermPerformance.overallRemark != null) ? getStudentTermPerformance.overallRemark : '' %></span></p>
                  <form method="POST" action="/dashboard/result/class?student=<%= student.id %>&term=<%= selectedTerm %>" class="d-flex align-items-center" style="gap: .5em;">
                    <input type="hidden" name="form" value="termPerformance">
                    <input type="hidden" name="student" value="<%= student.id %>">
                    <input type="hidden" name="term" value="<%= selectedTerm %>">
                    <label class="form-label mb-0" for="resultClass"><b>CLASS:</b></label>
                    <select id="resultClass" name="classId" class="form-select" style="max-width: 220px;">
                      <% classes.forEach(c => { %>
                        <option value="<%= c.id %>" <%= c.id == activeResultClassId ? 'selected' : '' %>><%= c.name %></option>
                      <% }) %>
                    </select>
                    <button type="submit" class="btn btn-outline-primary btn-sm" <%= !selectedTerm ? 'disabled' : '' %>>Update</button>
                  </form>
                </div>
                <% if(results.length > 0) { %>
                <div class="custom-table-responsive" style="">
                  <table class="table table-bordered table-striped" style="width: 100%;">
                    <thead class="table-dark">
                      <tr>
                        <th class="vertical-header">No</th>
                        <th class="vertical-header">Subjects</th>
                        <th class="vertical-header">First Test (10)</th>
                        <th class="vertical-header">Presentation (5)</th>
                        <th class="vertical-header">Mid-term test (10)</th>
                        <th class="vertical-header">Project (10)</th>
                        <th class="vertical-header">Note (5)</th>
                        <th class="vertical-header">Exam score (60)</th>
                        <th class="vertical-header">Total score (100)</th>
                        <th class="vertical-header">Grade</th>
                        <th class="vertical-header">Position</th>
                        <th class="vertical-header">Class lowest score</th>
                        <th class="vertical-header">Class highest score</th>
                        <th class="vertical-header">Remark</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% results.map((result, index) => { %>
                      <tr>
                        <td><%= ++index %></td>
                        <td><%= result.Subject ? result.Subject.name : "N/A" %></td>
                        <td><%= result.firstTest %></td>
                        <td><%= result.presentation %></td>
                        <td><%= result.midTermTest %></td>
                        <td><%= result.project %></td>
                        <td><%= result.note %></td>
                        <td><%= result.examScore %></td>
                        <td><%= result.totalScore %></td>
                        <td><%= result.grade %></td>
                        <td><%= result.position %></td>
                        <td><%= result.dataValues.classStats.classLowest %></td>
                        <td><%= result.dataValues.classStats.classHighest %></td>
                        <td><%= result.remark %></td>
                      </tr>
                      <% }) %>
                    </tbody>
                  </table>
                </div>
                <% } %>
                <% if(subjects.length > 0) { %>
                <% subjects.forEach(subject => { 
                let result = resultsMap[subject.id] || {}; // Get existing result or empty object
            %>
                <form method="POST">
                  <h4 class="mt-3"><%= subject.name %></h4>
                  <input type="hidden" name="form" value="results">
                  <input type="hidden" name="subject" value="<%= subject.id %>">

                  <% if(alert.status === "error" && alert.section === subject.id) { %>
                  <div class="alert alert-danger alert-dismissible" role="alert">
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    <div class="alert-message pr-5">
                      <strong>Error!</strong> <%- alert.message %>
                    </div>
                  </div>
                  <% } %>
                  <% if(alert.status === "success" && alert.section === subject.id) { %>
                  <div class="alert alert-success alert-dismissible" role="alert">
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    <div class="alert-message pr-5">
                      <strong>Sucess!</strong> <%- alert.message %>
                    </div>
                  </div>
                  <% } %>

                  <div class="row">
                    <div class="mb-3 col-md-3">
                      <label class="form-label" for="firstTest">First test score (0 - 10)</label>
                      <input type="number" class="form-control" name="firstTest" min="0" max="10" value="<%= (form.subject === subject.id) ? (form.firstTest ?? result.firstTest) : result.firstTest %>">
                    </div>
                    <div class="mb-3 col-md-3">
                      <label class="form-label" for="presentation">Presentation (0 - 5)</label>
                      <input type="number" class="form-control" name="presentation" min="0" max="5" value="<%= (form.subject === subject.id) ? (form.presentation ?? result.presentation) : result.presentation %>">
                    </div>
                    <div class="mb-3 col-md-3">
                      <label class="form-label" for="midTermTest">Mid Term Test (0 - 10)</label>
                      <input type="number" class="form-control" name="midTermTest" min="0" max="10" value="<%= (form.subject === subject.id) ? (form.midTermTest ?? result.midTermTest) : result.midTermTest %>">
                    </div>
                    <div class="mb-3 col-md-3">
                      <label class="form-label" for="project">Project (0 - 10)</label>
                      <input type="number" class="form-control" name="project" min="0" max="10" value="<%= (form.subject === subject.id) ? (form.project ?? result.project) : result.project %>">
                    </div>
                    <div class="mb-3 col-md-3">
                      <label class="form-label" for="note">Note (0 - 5)</label>
                      <input type="number" class="form-control" name="note" min="0" max="5" value="<%= (form.subject === subject.id) ? (form.note ?? result.note) : result.note %>">
                    </div>
                    <div class="mb-3 col-md-3">
                      <label class="form-label" for="examScore">Exam score (0 - 60)</label>
                      <input type="number" class="form-control" name="examScore" min="0" max="60" value="<%= (form.subject === subject.id) ? (form.examScore ?? result.examScore) : result.examScore %>">
                    </div>
                    <div class="mb-3 col-md-3">
                      <label class="form-label" for="totalScore">Total Score</label>
                      <input readonly type="number" class="form-control" name="totalScore" value="<%= (form.subject === subject.id) ? (form.totalScore ?? result.totalScore) : result.totalScore %>">
                    </div>
                    <div class="mb-3 col-md-3">
                      <label class="form-label" for="grade">Grade</label>
                      <input readonly type="text" class="form-control" name="grade" value="<%= (form.subject === subject.id) ? (form.grade ?? result.grade) : result.grade %>">
                    </div>
                    <div class="mb-3 col-md-12">
                      <label class="form-label" for="remark">Remark</label>
                      <textarea class="form-control" name="remark"><%= (form.subject === subject.id) ? (form.remark ?? result.remark) : result.remark %></textarea>
                    </div>
                  </div>
                  <button type="submit" class="btn btn-success mb-3">Update</button>
                </form>
                <% }) %>
                <% } else { %>
                <p class="text-center pt-3">No subjects found for this student</p>
                <% } %>
                <% } else { %>
                <p class="text-center pt-3">Please select a term to continue</p>
                <% } %>
              </div>

            </div>

          </div>
          <div class="tab-pane fade" id="password" role="tabpanel">
            <div class="card">
              <div class="card-body">
                <% if(selectedTerm) { %>
                <% if(subjects.length > 0) { %>
                <h5 class="card-title">Results info</h5>

                <% if(alert.status === "error" && alert.section === "remarks") { %>
                <div class="alert alert-danger alert-dismissible" role="alert">
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                  <div class="alert-message pr-5">
                    <strong>Error!</strong> <%- alert.message %>
                  </div>
                </div>
                <% } %>
                <% if(alert.status === "success" && alert.section === "remarks") { %>
                <div class="alert alert-success alert-dismissible" role="alert">
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                  <div class="alert-message pr-5">
                    <strong>Sucess!</strong> <%- alert.message %>
                  </div>
                </div>
                <% } %>

                <form method="POST">
                  <input type="hidden" name="form" value="remarks">
                  <div class="mb-3">
                    <label class="form-label" for="generalRemark">General Remark</label>
                    <textarea name="generalRemark" class="form-control" id="generalRemark"><%= form.generalRemark || getStudentTermPerformance.overallRemark %></textarea>
                  </div>
                  <div class="mb-3">
                    <label class="form-label" for="teacherRemark">Teacher's Remark</label>
                    <textarea name="teacherRemark" class="form-control" id="teacherRemark"><%= form.teacherRemark || getStudentTermPerformance.teachersRemark %></textarea>
                  </div>
                  <button type="submit" class="btn btn-primary">Save changes</button>
                </form>
                <% } else { %>
                <p class="text-center pt-3">No subjects found for this student</p>
                <% } %>
                <% } else { %>
                <p class="text-center pt-3">Please select a term to continue</p>
                <% } %>

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</main>

<script>
    document.addEventListener("DOMContentLoaded", function() {
      // Restore active tab from sessionStorage
      const activeTab = sessionStorage.getItem("activeTab");
      if (activeTab) {
        let activeTabElement = document.querySelector(`a[href="${activeTab}"]`);
        if (activeTabElement) {
        document.querySelectorAll('.nav-link').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-pane').forEach(tabPane => tabPane.classList.remove('show', 'active'));

        activeTabElement.classList.add('active');
        document.querySelector(activeTab).classList.add('show', 'active');
      }
    }

    // Save active tab on click
    document.querySelectorAll('.nav-link').forEach(tab => {
      tab.addEventListener('click', function() {
        sessionStorage.setItem("activeTab", this.getAttribute("href"));
      });
    });


    const select = document.getElementById("term");

    select.addEventListener("change", function() {
      const selectedTermId = this.value;
      let currentUrl = new URL(window.location.href); // Parse current URL
      let studentId = currentUrl.searchParams.get("student"); // Get 'student' parameter

      if (studentId) {
        // Update the term in the URL
        currentUrl.searchParams.set("term", selectedTermId);
        window.location.href = currentUrl.toString(); // Redirect to updated URL
      } else {
        console.error("Student ID not found in the URL.");
      }
    });

    document.querySelectorAll("form").forEach((form) => {
      const firstTestEl = form.querySelector("[name='firstTest']");
      if (!firstTestEl) return;
      form.addEventListener("input", function() {
        const getVal = (name) => {
          const el = form.querySelector(`[name='${name}']`);
          return el ? parseFloat(el.value) || 0 : 0;
        };
        const firstTest = getVal('firstTest');
        const presentation = getVal('presentation');
        const midTermTest = getVal('midTermTest');
        const project = getVal('project');
        const note = getVal('note');
        const exam = getVal('examScore');

        const totalScore = firstTest + presentation + midTermTest + project + note + exam;
        const totalEl = form.querySelector("[name='totalScore']");
        const gradeEl = form.querySelector("[name='grade']");
        if (totalEl) totalEl.value = totalScore;

        let grade;
        if (totalScore >= 70) grade = "A";
        else if (totalScore >= 60) grade = "B";
        else if (totalScore >= 50) grade = "C";
        else if (totalScore >= 40) grade = "D";
        else grade = "F";
        if (gradeEl) gradeEl.value = grade;
      });
    });
  });
</script>

<style>
  .custom-table-responsive {
    overflow-x: auto;
  }
</style>


<%- include("../../partials/footer") %>
